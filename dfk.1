.\" Automatically generated by Pandoc 2.9.2
.\"
.TH "DFK" "1" "2020/05/03" "Dual Function Keys" "User Manuals"
.hy
.SH NAME
.PP
dfk - dual function keys
.SH DESCRIPTION
.PP
Tap for one key, hold for another.
.PP
Great for modifier keys like: hold for ctrl, tap for delete.
.PP
A plugin for interception tools (https://gitlab.com/interception/linux).
.SH FUNCTIONALITY
.PP
In these examples we will use the left shift key (LS).
.PP
It is configured to tap for backspace (BS) and hold for LS.
.SS Tap
.PP
Press and release LS within TAP_MILLIS (default 200ms) for BS.
.PP
Until the tap is complete, we get LS.
.IP
.nf
\f[C]
                <---------200ms--------->     <---------200ms--------->
keyboard:       LS\[da]      LS\[ua]                  LS\[da]                          LS\[ua]
computer sees:  LS\[da]      LS\[ua] BS\[da] BS\[ua]          LS\[da]                          LS\[ua]
\f[R]
.fi
.SS Double Tap
.PP
Tap then press again with DOUBLE_TAP_MILLIS (default 150ms) to hold BS.
.IP
.nf
\f[C]
                             <-------150ms------->
                <---------200ms--------->
keyboard:       LS\[da]         LS\[ua]             LS\[da]               LS\[ua]
computer sees:  LS\[da]         LS\[ua] BS\[da] BS\[ua]     BS\[da] ..(repeats).. BS\[ua]
\f[R]
.fi
.PP
You can continue double tapping so long as it is within the DOUBLE_TAP_MILLIS window.
.SS Consumption
.PP
Press or release another key during the TAP_MILLIS window and the tap will not occur.
.PP
This is especially useful for modifiers, for instance a quick ctrl-C.
In this example we press the a key during the window.
.PP
Double taps do not apply after consumption; you will need to tap first.
.IP
.nf
\f[C]
                                                               <-------150ms------->
                                                 <---------200ms--------->
                                 <-------150ms------->
                <---------200ms--------->
keyboard:       LS\[da]   a\[da]  a\[ua]     LS\[ua]             LS\[da]          LS\[ua]           LS\[da]
computer sees:  LS\[da]              LS\[ua]             LS\[da]          LS\[ua] BS\[da] BS\[ua]   BS\[da] ..(repeats)..
\f[R]
.fi
.SH INSTALLATION
.PP
Arch Linux users may install from the AUR: interception-dfk (https://aur.archlinux.org/packages/interception-dfk).
.SH BUILDING
.PP
See dependencies (https://gitlab.com/interception/linux/tools#dependencies).
.IP
.nf
\f[C]
git clone git\[at]github.com:alex-courtis/dfk.git
cd dfk
make && sudo make install
\f[R]
.fi
.PP
Installation prefix defaults to \f[C]/usr/local\f[R].
This can be overridden in \f[C]config.mk\f[R].
.SH CONFIGURATION
.PP
There are two parts to be configured: dfk and udevmon, which launches dfk.
.PP
See examples (https://github.com/alex-courtis/dfk/tree/master/examples) which contains dfk and udevmon configurations.
.SS dfk
.PP
This yaml file can go anywhere.
.PP
You can use raw (integer) keycodes, however it is easier to use the \f[C]#define\f[R]d strings from input-event-codes.h (https://github.com/torvalds/linux/blob/master/include/uapi/linux/input-event-codes.h).
.IP
.nf
\f[C]
# optional
TIMING:
    TAP_MILLISEC: <integer>
    DOUBLE_TAP_MILLISEC: <integer>

# necessary
MAPPINGS:
    - KEY: <integer | string>
      TAP: <integer | string>
      HOLD: <integer | string>
    - KEY: ...
\f[R]
.fi
.PP
Our example from the previous section looks like:
.IP
.nf
\f[C]
TIMING:
    TAP_MILLISEC: 200
    DOUBLE_TAP_MILLISEC: 150

MAPPINGS:
    - KEY: KEY_LEFTSHIFT
      TAP: KEY_DELETE
      HOLD: KEY_LEFTSHIFT
\f[R]
.fi
.SS udevmon
.PP
udevmon needs to be informed that we desire Dual Function Keys.
See How It Works (https://gitlab.com/interception/linux/tools#how-it-works) for the full story.
.IP
.nf
\f[C]
- JOB: \[dq]intercept -g $DEVNODE | dfk -c </path/to/dfk.yaml> | uinput -d $DEVNODE\[dq]
  DEVICE:
    NAME: <keyboard name>
\f[R]
.fi
.PP
Usually the name is sufficient to uniquely identify the keyboard, however some keyboards register many devices such as a virtal mouse.
You can run dfk for all the devices, however I prefer to run it only for the actual keyboard.
.PP
See uinput -p (https://gitlab.com/interception/linux/tools#how-it-works) for instructions on how to get this information.
.PP
My \f[C]/etc/udevmon.yml\f[R]:
.IP
.nf
\f[C]
- JOB: \[dq]intercept -g $DEVNODE | dfk -c /etc/dfk.home-row-modifiers.yaml | uinput -d $DEVNODE\[dq]
  DEVICE:
    NAME: \[dq]q.m.k HHKB mod Keyboard\[dq]
- JOB: \[dq]intercept -g $DEVNODE | dfk -c /etc/dfk.kinesis-advantage-2.yaml | uinput -d $DEVNODE\[dq]
  DEVICE:
    NAME: \[dq]Kinesis Advantage2 Keyboard\[dq]
    EVENTS:
      EV_KEY: [ KEY_LEFTSHIFT ]
\f[R]
.fi
.SH CAVEATS
.PP
As always, there is a caveat: dfk operates on raw \f[I]keycodes\f[R], not \f[I]keysyms\f[R], as seen by X11 or Wayland.
.PP
If you have anything modifying the keycode->keysym mapping, such as XKB (https://www.x.org/wiki/XKB/) or xmodmap (https://wiki.archlinux.org/index.php/Xmodmap), be mindful that dfk operates before them.
.PP
Some common XKB usages that might be found in your X11 configuration:
.IP
.nf
\f[C]
    Option \[dq]XkbModel\[dq] \[dq]pc105\[dq]
    Option \[dq]XKbLayout\[dq] \[dq]us\[dq]
    Option \[dq]XkbVariant\[dq] \[dq]dvp\[dq]
    Option \[dq]XkbOptions\[dq] \[dq]caps:escape\[dq]
\f[R]
.fi
.SH FAQ
.PP
\f[I]I have a new use case. Can you support it?\f[R]
.PP
dfk has been built for my needs.
I will be intrigued to hear your ideas and help you make them happen.
.PP
As usual, PRs are very welcome.
.PP
\f[I]I see you are using q.m.k HHKB mod Keyboard in your udevmon. It uses QMK Firmware (https://qmk.fm/). Why not just use Tap-Hold (https://docs.qmk.fm/#/tap_hold)?\f[R]
.PP
Good catch! That does indeed provide the same functionality as dfk.
Unfortunately there are some drawbacks:
.IP "1." 3
Few keyboards run QMK Firmware.
.IP "2." 3
There are some issues with that functionality, as noted in the documentation Tap-Hold (https://docs.qmk.fm/).
.IP "3." 3
It requires a fast processor in the keyboard.
My unscientific testing with an Ergodox (\[ti]800 scans/sec) and HHKB (\[ti]140) revealed that the slower keyboard is mushy and unuseably inaccurate.
.PP
\f[I]Why not use xcape (https://github.com/alols/xcape)?\f[R]
.PP
Xcape only provides simple tap/hold functionality.
It appears difficult (impossible?) to add the remaining functionality using its XTestFakeKeyEvent mechanisms.
.SH CONTRIBUTORS
.PP
Please fork this repo and submit a PR.
.PP
If you are making changes to the documentation, please edit the pandoc flavoured \f[C]dfk.md\f[R] and run \f[C]make doc\f[R].
Please ensure that this \f[C]README.md\f[R] and the man page \f[C]dfk.1\f[R] has your changes and commit all three.
.PP
As usual, please obey \f[C].editorconfig\f[R].
.SH LICENSE
.PP
.PP
Copyright \[co] 2020 Alexander Courtis
.SH AUTHORS
Alexander Courtis.
